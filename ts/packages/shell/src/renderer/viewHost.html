<!doctype html>
<!-- Copyright (c) Microsoft Corporation.
 Licensed under the MIT License. -->

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }

      .header {
        position: absolute;
        top: 0;
        /* Start at divider position */
        left: 400px;
        right: 0;
        height: 40px;
        background: #f5f5f5;
        border-bottom: 1px solid #ddd;
        display: flex;
        align-items: center;
        z-index: 1000;
        /* Hidden by default, shown when browser is open */
        visibility: hidden;
      }

      .header.visible {
        visibility: visible;
      }

      .browser-nav {
        display: flex;
        align-items: center;
        padding: 0 8px;
        gap: 4px;
      }

      .nav-button {
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        border-radius: 3px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }

      .nav-button i {
        font-size: 11px;
      }

      .nav-button:hover {
        background: #e0e0e0;
      }

      .nav-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .nav-button:disabled:hover {
        background: transparent;
      }

      .tab-bar {
        flex: 1;
        display: flex;
        align-items: center;
        overflow: hidden;
        padding: 0 4px;
      }

      .tab {
        min-width: 120px;
        max-width: 200px;
        height: 32px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 6px 6px 0 0;
        margin-right: 2px;
        display: flex;
        align-items: center;
        padding: 0 8px;
        cursor: pointer;
        font-size: 12px;
        overflow: hidden;
        user-select: none;
        -webkit-user-select: none;
      }

      .tab.active {
        background: #fff;
        border-bottom-color: #fff;
        z-index: 1;
      }

      .tab:not(.active) {
        background: #f0f0f0;
      }

      .tab-favicon {
        width: 16px;
        height: 16px;
        margin-right: 6px;
        flex-shrink: 0;
      }

      .tab-title {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .tab-close {
        width: 16px;
        height: 16px;
        margin-left: 4px;
        background: transparent;
        border: none;
        border-radius: 2px;
        cursor: pointer;
        font-size: 8px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .tab-close:hover {
        background: #e0e0e0;
      }

      .add-tab-button {
        width: 28px;
        height: 28px;
        background: transparent;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        margin-right: 8px;
      }

      .add-tab-button:hover {
        background: #f0f0f0;
      }

      .divider-vertical {
        position: absolute;
        /* Full height always */
        top: 0;
        bottom: 0;
        left: 400px;
        width: 5px;
        cursor: ew-resize;
        background-color: #ddd;
        /* Hidden initially */
        visibility: hidden;
      }

      .divider-horizontal {
        position: absolute;
        /* Full width always */
        left: 0;
        right: 0;
        top: 40px;
        height: 5px;
        cursor: ns-resize;
        background-color: #ddd;
        /* Hidden initially */
        visibility: hidden;
      }
    </style>
  </head>

  <body>
    <!-- Header for browser navigation and tabs -->
    <div class="header" id="header">
      <!-- Browser navigation controls -->
      <div class="browser-nav">
        <button class="nav-button" id="layout-toggle-btn" title="Toggle Layout">
          <svg width="14" height="14" viewBox="0 0 16 16" id="layout-icon">
            <!-- Side panel icon (default) -->
            <g id="side-panel-icon">
              <rect x="1" y="2" width="6" height="12" fill="currentColor" stroke="currentColor" stroke-width="0.5"/>
              <rect x="9" y="2" width="6" height="12" fill="none" stroke="currentColor" stroke-width="0.5"/>
            </g>
            <!-- Bottom panel icon (hidden by default) -->
            <g id="bottom-panel-icon" style="display: none;">
              <rect x="1" y="2" width="14" height="5" fill="currentColor" stroke="currentColor" stroke-width="0.5"/>
              <rect x="1" y="9" width="14" height="5" fill="none" stroke="currentColor" stroke-width="0.5"/>
            </g>
          </svg>
        </button>
        <button class="nav-button" id="back-btn" title="Back" disabled>
          <i class="fas fa-arrow-left"></i>
        </button>
        <button class="nav-button" id="forward-btn" title="Forward" disabled>
          <i class="fas fa-arrow-right"></i>
        </button>
        <button class="nav-button" id="reload-btn" title="Reload">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>

      <!-- Tab bar -->
      <div class="tab-bar" id="tab-bar">
        <!-- Tabs will be dynamically added here -->
      </div>

      <!-- Add tab button -->
      <button class="add-tab-button" id="add-tab-btn" title="New Tab">
        <i class="fas fa-plus"></i>
      </button>
    </div>

    <div class="divider-vertical" id="divider-vertical"></div>
    <div class="divider-horizontal" id="divider-horizontal"></div>
    <script>
      const ipcRenderer = window.electron.ipcRenderer;

      // DOM elements
      const header = document.getElementById("header");
      const dividerVertical = document.getElementById("divider-vertical");
      const dividerHorizontal = document.getElementById("divider-horizontal");
      const tabBar = document.getElementById("tab-bar");
      const backBtn = document.getElementById("back-btn");
      const forwardBtn = document.getElementById("forward-btn");
      const reloadBtn = document.getElementById("reload-btn");
      const addTabBtn = document.getElementById("add-tab-btn");
      const layoutToggleBtn = document.getElementById("layout-toggle-btn");
      const sidePanelIcon = document.getElementById("side-panel-icon");
      const bottomPanelIcon = document.getElementById("bottom-panel-icon");

      // State
      let isDragging = false;
      let tabs = [];
      let activeTabId = null;
      let verticalLayout = false;

      // Divider functionality
      dividerVertical.addEventListener("mousedown", () => {
        isDragging = true;
      });

      dividerHorizontal.addEventListener("mousedown", () => {
        isDragging = true;
      });
      window.addEventListener("mousemove", (e) => {
        if (!isDragging) return;
        if (verticalLayout) {
          const newY = e.clientY;
          dividerHorizontal.style.top = `${newY}px`;
          ipcRenderer.send("views-resized-by-user", newY);
        } else {
          const newX = e.clientX;
          dividerVertical.style.left = `${newX}px`;
          header.style.left = `${newX + 5}px`; // Position header just after divider
          ipcRenderer.send("views-resized-by-user", newX);
        }
      });

      window.addEventListener("mouseup", () => {
        isDragging = false;
      });

      // Handle browser navigation
      backBtn.addEventListener("click", () => {
        ipcRenderer.send("browser-go-back");
      });

      forwardBtn.addEventListener("click", () => {
        ipcRenderer.send("browser-go-forward");
      });

      reloadBtn.addEventListener("click", () => {
        ipcRenderer.send("browser-reload");
      });

      addTabBtn.addEventListener("click", () => {
        ipcRenderer.send("browser-new-tab");
      });

      layoutToggleBtn.addEventListener("click", () => {
        ipcRenderer.send("toggle-layout");
      });

      // Tab management functions
      function createTabElement(tab) {
        const tabElement = document.createElement("div");
        tabElement.className = `tab ${tab.id === activeTabId ? "active" : ""}`;
        tabElement.dataset.tabId = tab.id;

        // Create favicon element with fallback
        const faviconSrc =
          tab.favicon ||
          `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><circle cx="8" cy="8" r="7" fill="#ccc"/></svg>')}`;

        tabElement.innerHTML = `
          <img class="tab-favicon" src="${faviconSrc}" alt="" onerror="this.src='data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><circle cx="8" cy="8" r="7" fill="#ccc"/></svg>')}'">
          <span class="tab-title">${tab.title || "New Tab"}</span>
          <button class="tab-close"><i class="fas fa-times"></i></button>
        `;

        const closeButton = tabElement.querySelector(".tab-close");
        // Tab click handler
        tabElement.addEventListener("click", (e) => {
          if (e.target !== closeButton) {
            switchTab(tab.id);
          }
        });

        // Tab close handler
        tabElement.addEventListener("auxclick", (e) => {
          if (e.button === 1) {
            // Middle click
            e.stopPropagation();
            closeTab(tab.id);
          }
        });
        closeButton.addEventListener("click", (e) => {
          e.stopPropagation();
          closeTab(tab.id);
        });

        return tabElement;
      }

      function updateTabBar() {
        tabBar.innerHTML = "";
        tabs.forEach((tab) => {
          tabBar.appendChild(createTabElement(tab));
        });
      }

      function switchTab(tabId) {
        activeTabId = tabId;
        updateTabBar();
        ipcRenderer.send("browser-switch-tab", tabId);
      }

      function closeTab(tabId) {
        ipcRenderer.send("browser-close-tab", tabId);
      }

      function updateHeaderVisibility() {
        const hasBrowserContent = tabs.length > 0;
        // Always show header for layout toggle button
        header.classList.add("visible");
        // Hide browser-specific controls when no tabs
        backBtn.style.display = hasBrowserContent ? 'flex' : 'none';
        forwardBtn.style.display = hasBrowserContent ? 'flex' : 'none';
        reloadBtn.style.display = hasBrowserContent ? 'flex' : 'none';
        addTabBtn.style.display = hasBrowserContent ? 'flex' : 'none';
        tabBar.style.display = hasBrowserContent ? 'flex' : 'none';
      }

      function updateNavigationState(navigationState) {
        backBtn.disabled = !navigationState.canGoBack;
        forwardBtn.disabled = !navigationState.canGoForward;
      }

      function updateLayoutIcon() {
        if (verticalLayout) {
          // Vertical layout: chat at bottom, show side panel icon
          sidePanelIcon.style.display = 'block';
          bottomPanelIcon.style.display = 'none';
          layoutToggleBtn.title = 'Switch to side layout';
        } else {
          // Horizontal layout: chat at side, show bottom panel icon  
          sidePanelIcon.style.display = 'none';
          bottomPanelIcon.style.display = 'block';
          layoutToggleBtn.title = 'Switch to bottom layout';
        }
      }

      // IPC handlers
      ipcRenderer.on("set-layout", (_, layout) => {
        verticalLayout = layout.verticalLayout;
        if (verticalLayout) {
          dividerVertical.style.visibility = "hidden";
          const newY = layout.pos;
          if (newY < 0) {
            dividerHorizontal.style.visibility = "hidden";
            // Keep header visible for layout toggle, but hide browser controls
            header.classList.add("visible");
            updateHeaderVisibility();
          } else {
            dividerHorizontal.style.top = `${newY}px`;
            dividerHorizontal.style.visibility = "visible";
            header.style.left = "0px";
            header.classList.add("visible");
            updateHeaderVisibility();
          }
        } else {
          dividerHorizontal.style.visibility = "hidden";
          const newX = layout.pos;
          if (newX < 0) {
            dividerVertical.style.visibility = "hidden";
            // Keep header visible for layout toggle, but hide browser controls
            header.classList.add("visible");
            updateHeaderVisibility();
          } else {
            dividerVertical.style.left = `${newX}px`;
            dividerVertical.style.visibility = "visible";
            header.style.left = `${newX + 5}px`; // Position header just after divider
            header.classList.add("visible");
            updateHeaderVisibility();
          }
        }
        updateLayoutIcon();
      });

      // Tab management IPC handlers
      ipcRenderer.on("browser-tabs-updated", (_, tabsData) => {
        tabs = tabsData.tabs;
        activeTabId = tabsData.activeTabId;
        updateTabBar();
        updateHeaderVisibility();

        // Update navigation state if we have an active tab
        if (tabsData.navigationState) {
          updateNavigationState(tabsData.navigationState);
        }
      });

      ipcRenderer.on("browser-navigation-updated", (_, navigationState) => {
        updateNavigationState(navigationState);
      });

      ipcRenderer.on("browser-tab-closed", (_, tabId) => {
        document.querySelector(`div.tab[data-tab-id="${tabId}"]`)?.remove();
      });

      // Initialize layout icon on page load
      document.addEventListener('DOMContentLoaded', () => {
        updateLayoutIcon();
        updateHeaderVisibility();
      });
    </script>
  </body>
</html>
