# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

trigger:
  branches:
    include:
      - main

pr:
  branches:
    exclude:
      - "*"

variables:
  workingDirectory: "ts"
  shell_folder: "ts/packages/shell"
  nodeVersion: "22"

jobs:
  - job: build_package_shell
    displayName: "TypeAgent Shell"
    strategy:
      matrix:
        windows:
          image: "windows-latest"
        linux:
          image: "ubuntu-latest"
        mac:
          image: "macos-latest"
    pool:
      vmImage: "$(image)"
    steps:
      - script: |
          sudo apt install libsecret-1-0
        displayName: "Install libsecret-1-0"
        condition: eq(variables['Agent.OS'], 'Linux')

      - checkout: self
        displayName: "Checkout TypeAgent Repository"
        path: "typeagent"

      - task: UseNode@1
        displayName: "Setup Node.js"
        inputs:
          version: $(nodeVersion)
          checkLatest: true

      - template: include-install-pnpm.yml
        parameters:
          buildDirectory: $(Build.SourcesDirectory)/ts

      - script: |
          pnpm install --frozen-lockfile --strict-peer-dependencies
        displayName: "Install dependencies"
        workingDirectory: $(workingDirectory)

      - template: include-update-package-version.yml
        parameters:
          packageFolder: $(shell_folder)

      - script: |
          pnpm run build:shell
        displayName: "Build"
        workingDirectory: $(workingDirectory)

      - bash: |
          if [[ '$(Agent.OS)' == 'Linux' ]]; then
            pnpm run shell:package:linux
          elif [[ '$(Agent.OS)' == 'Darwin' ]]; then
            pnpm run shell:package:mac
          elif [[ '$(Agent.OS)' == 'Windows_NT' ]]; then
            pnpm run shell:package:win
          fi
        displayName: "Package - shell"
        workingDirectory: $(workingDirectory)

      - publish: $(shell_folder)/dist
        displayName: "Publish"
        artifact: "shell-$(Agent.OS)"
