# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  node_version: '18'
  pnpm_version: '9.0.0'
  typeagent_repo: 'https://github.com/microsoft/typeagent.git'
  workingDirectory: 'typeagent/ts'
  ado_registry: 'https://pkgs.dev.azure.com/msctoproj/AI_Systems/_packaging/typeagent/npm/registry/'

jobs:
- job: build_ts
  displayName: 'Build TypeScript Project'
  strategy:
    matrix:
      nodeVersion: ['18', '20']
  steps:
  - script: |
      git config --global core.autocrlf false
    displayName: 'Setup Git LF'

  - script: |
      git clone $(typeagent_repo) typeagent
    displayName: 'Clone typeagent Repository'

  - script: |
      curl -fsSL https://get.pnpm.io/v6.14.js | node - add --global pnpm@$(pnpm_version)
      export PNPM_HOME="$HOME/.local/share/pnpm"
      export PATH="$PNPM_HOME:$PATH"
    displayName: 'Install pnpm'
    condition: always()

  - task: UseNode@1
    displayName: 'Setup Node.js'
    inputs:
      version: $(nodeVersion)
      checkLatest: true

  - script: |
      pnpm install --frozen-lockfile --strict-peer-dependencies
    displayName: 'Install dependencies'
    workingDirectory: $(workingDirectory)

  - script: |
      npm run build
    displayName: 'Build'
    workingDirectory: $(workingDirectory)

  - script: |
      npm run test
    displayName: 'Run Tests'
    workingDirectory: $(workingDirectory)

  - script: |
      npm run lint
    displayName: 'Lint'
    workingDirectory: $(workingDirectory)

  - script: |
      cd $(Build.SourcesDirectory)/$(workingDirectory)/packages/agentSdk/dist
      npm pack
    displayName: 'Pack agent-sdk module'

  - task: npmAuthenticate@0
    inputs:
      workingFile: .npmrc
    displayName: 'Authenticate with Azure Artifacts'

  - script: |
      npm publish --registry=$(ado_registry)
    displayName: 'Publish agent-sdk Module'
    condition: succeeded()
